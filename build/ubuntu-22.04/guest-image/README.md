# Ubuntu 22.04 TDX Guest Image

Customize Ubuntu 22.04 cloud image and install TDX guest kernel.

## Prerequisites

- The script will install TDX guest packages from `../guest_repo/`. If not present, please build the guest repo in the upper build directory:

`./pkg-builder -c "build-repo.sh guest"`

- Install qemu-img and virt-customize. For Ubuntu:

`sudo apt install -y qemu-utils libguestfs-tools`

## Steps

- Run the script to generate `td-guest-ubuntu-22.04.qcow2`. The login credential for the guest is `root/123456`.

  ```
  Usage: create-ubuntu-image.sh [OPTION]...
Required
  -r <guest repo>           Specify the directory including guest packages, generated by build-repo.sh or remote repo
Test suite
  -t                        Install test suite
Optional
  -v <kernel version>       Specify the version of the guest kernel, like 6.2.16-mvp30v3+7-generic of
                            linux-image-unsigned-6.2.16-mvp30v3+7-generic. If the guest repo is remote,
                            the option is necessary. 
  -a                        Auth file that will be placed in /etc/apt/auth.conf.d
  -h                        Show this help
  -f                        Force to recreate the output image
  -n                        Guest host name, default is "tdx-guest"
  -u                        Guest user name, default is "tdx"
  -p                        Guest password, default is "123456"
  -s                        Specify the size of guest image
  -o <output file>          Specify the output file, default is tdx-guest-ubuntu-22.04.qcow2.
                            Please make sure the suffix is qcow2. Due to permission consideration,
                            the output file will be put into /tmp/<output file>.
  -b                        Debug Mode
                            - enable root login
Customization
  -g                        Customized cloud-config appended to the user-data
  -x                        Customized script appended to the user-data (running after all runcmd in cloud-config)
  -i                        Customized script run by virt-customize before invoking cloud-init (the script is interpreted by /bin/sh)
  -d                        Customized script run by virt-customize after invoking cloud-init (the script is interpreted by /bin/sh)
  ```

  NOTE:
  - Please refer https://cloudinit.readthedocs.io/en/latest/reference/examples.html for cloud-init configuration, then update [user-data.template](./cloud-init-data/user-data.template)
  - Please refer https://www.libguestfs.org/virt-customize.1.html for more customizations via `virt-customize`

## 4. Examples

1. Build a default disk image
  
  ```
  sudo ./create-ubuntu-image.sh -r $GUEST_REPO -f
  ```
  The script will build a 20G disk image at /tmp/tdx-guest-ubuntu-22.04.qcow2. It has a `root` user with password `xxxx`. The option `-f` indicate that the existing image will be overwritten forcibly.

  The `GUEST_REPO` is the path to a guest repo, which has the following file hierarchy.

  ```
    guest_repo/jammy
    |- all/
    |- amd64/
  ```

  The guest repo can be a local repo, such as the repo built by `build_repo.sh`. If you build a local repo previously, you can run the command simply.

  ```
  sudo ./create-ubuntu-image.sh -f -r ../guest_repo/
  ```

  
  If the guest repo is a remote repo, such as "https://host/guest_repo", an option `-v` should be appended to specify the version of the guest kernel.

  ```
  sudo ./create-ubuntu-image.sh -r $GUEST_REPO -f -v 6.16-mvp30v3+7-generic
  ```

  Furthermore, if the remote repo requires user authentication, you can provide a config file, which will be placed in `/etc/apt/auth.conf.d` of the vm. The option `-a` will help copy the config file.

  ```
  sudo ./create-ubuntu-image.sh -r $GUEST_REPO -f -v 6.16-mvp30v3+7-generic -a $AUTH_FILE
  ```

  NOTE:
  - `sudo` is not required if current user is in libvirt (RHEL style) or libvirt-qemu (Ubuntu style)
  - By default, the output file will be put at /tmp/tdx-guest-ubuntu-22.04.qcow2


2. Specify the size of disk image

  ```
  sudo ./create-ubuntu-image.sh -r ../guest_repo/ -f -s 50
  ```



3. Specify the output file name

  ```
  sudo ./create-ubuntu-image.sh -r ../guest_repo/ -f -o mytest.qcow2
  ```
  NOTE:
  - Please make sure the output file name is ends with `*.qcow2`


4. Specify the `user name`, `password` and `hostname`

  ```
  sudo ./create-ubuntu-image.sh -r ../guest_repo/ -f -o mytest.qcow2 -u tdx -p changeme -n tdx-guest
  ```

5. Install image with test suite

  ```
  sudo ./create-ubuntu-image.sh -f -r ${GUEST_REPO} -t
  ```
  The option `-t` helps to install test suite in the guest image. The option `-e` helps to specify a host repo to install `qemu-guest-agent`. The option `-d` opens the debug mode, if you use `root` user of guest, the option must be added.

6. Customize guest image

6.1 Customize user-data for cloud-init

The cloud-init is the center of own guest building, therefore we provides two options to extend the basic guest image or the testing guest image. The option `-g` appends the customized cloud-config to user-data, and the option `-x` appends a script to it. Remember the first of the cloud-config must be `#cloud-config` and the first line of the scripts must be `#!`. 

For example, create anther cloud-config and modify it to install a binary `tree` in the guest image.

```
cp ./cloud-init-data/user-data-basic/cloud-config-base-template.yaml ./cloud-init-data/cloud-config-example.yaml

echo -e "packages:\n  - tree" >>  ./cloud-init-data/cloud-config-example.yaml

sudo ./create-ubuntu-image.sh -f -r ${GUEST_REPO} -g ./cloud-init-data/cloud-config-example.yaml
```


The note we must mention is that, the `runcmd` of the cloud-config and script in the user-data are running in the context without environment variables, if your commands depend on some of them, such a network proxy, please declare them manually. For example, exporting environment variables at the beginning of your scripts.

```
#!/bin/bash

while read env_var; do
  export "$env_var"
done < /etc/environment

...
```

For example, install golang 1.20.7 during the cloud-init.

```
sudo ./create-ubuntu-image.sh -f -r ${GUEST_REPO} -x ./cloud-init-data/init-scripts/basic-install-go1.20.7.sh
```


6.2 Customize scripts before or after cloud-init

Given that some works can be executed before cloud-init or after cloud-init, the option `-i` and the option `-d` provide hooks there respectively. The scripts you provide via `-i` and `-d` will be executed by the tool `virt-customize` with shell interpreter `/bin/sh`. Unfortunately, the bash syntax is not compatible with sh completely, make sure your scripts can be explained by the sh. 

For example, you can install golang 1.20.7 before cloud-init by the command, 

```
sudo ./create-ubuntu-image.sh -f -r ${GUEST_REPO} -i ./cloud-init-data/init-scripts/basic-install-go1.20.7.sh
```

or install golang 1.20.7 after cloud-init by the command.

```
sudo ./create-ubuntu-image.sh -f -r ${GUEST_REPO} -d ./cloud-init-data/init-scripts/basic-install-go1.20.7.sh
```

The `virt-customize` is a powerful tool, but it does not launch a real vm, therefore daemon services are inaccessible, some commands, such `docker pull` can not be executed. Such commands should be appended in user-data as above mentioned.

Please refer [cloud-init](https://cloudinit.readthedocs.io/en/latest/), [user-data](https://cloudinit.readthedocs.io/en/latest/explanation/format.html#) and [cloud-config](https://cloudinit.readthedocs.io/en/latest/reference/modules.html) to get more info about `cloud-init`. Besides, two templates [cloud-config-base-template.yaml](build/ubuntu-22.04/guest-image/cloud-init-data/user-data-basic/cloud-config-base-template.yaml) and [cloud-config-test-suite-template.yaml](build/ubuntu-22.04/guest-image/cloud-init-data/user-data-customized/cloud-config-test-suite-template.yaml) are direct examples.

Refer [virt-customize](https://www.libguestfs.org/virt-customize.1.html) to learn more about it. 

6.3 Build a guest image with amber-cli

```
sudo ./create-ubuntu-image.sh -f -r ../guest_repo/ -i ./cloud-init-data/init-scripts/install-dcap.sh -g ./cloud-init-data/user-data-customized/cloud-config-amber-cli.yaml 
```

Given that the amber-cli depends on the libraries in the dcap package, the script `./cloud-init-data/init-scripts/install-dcap.sh` installs dcap before cloud-init being invoked.





